---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import CategoryBadge from '../../components/CategoryBadge.astro';
import DepthMeter from '../../components/DepthMeter.astro';
import { formatPublishDate } from '../../lib/formatPublishDate';
const basePath = import.meta.env.BASE_URL.replace(/\/+$/, '/');

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog', ({ data }) => {
    return data.draft !== true;
  });

  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();
---

<Layout title={post.data.title} description={post.data.description}>
  <article class="max-w-3xl mx-auto px-6 py-12">

    <!-- Back navigation -->
    <a href={basePath}
       class="inline-flex items-center gap-2 text-amber-dim hover:text-amber
              transition-colors duration-200 mb-8 text-sm tracking-wider font-mono">
      &larr; back to collection
    </a>

    <!-- Article header -->
    <header class="mb-12 border border-vault-raised p-8 bg-vault-mid relative">
      <div class="bracket-corners"></div>

      <div class="flex flex-wrap items-center gap-4 mb-6">
        <CategoryBadge category={post.data.hyperfixation} />
        <DepthMeter depth={post.data.researchDepth} />
        <time class="text-sm text-faded ml-auto font-mono">
          {formatPublishDate(post.data.publishDate)}
        </time>
      </div>

      <h1 class="font-heading text-4xl md:text-5xl font-bold text-ivory mb-4 leading-tight">
        {post.data.title}
      </h1>

      <p class="text-lg text-dust leading-relaxed mb-6">
        {post.data.description}
      </p>

      <div class="flex gap-2 flex-wrap">
        {post.data.tags.map((tag: string) => (
          <span class="text-xs text-faded font-mono px-2 py-0.5 bg-vault-panel">
            {tag}
          </span>
        ))}
      </div>
    </header>

    <!-- Article content -->
    <div class="prose prose-lg max-w-none">
      <Content />
    </div>

    <!-- Sources footer -->
    {post.data.sources && post.data.sources.length > 0 && (
      <footer class="mt-16 pt-8 relative">
        <div class="rule-amber mb-8"></div>
        <h2 class="font-heading text-xl text-amber tracking-widest uppercase mb-6">
          Sources &amp; References
        </h2>
        <ul class="space-y-3">
          {post.data.sources.map((source: string, i: number) => (
            <li class="flex items-start gap-3">
              <span class="font-mono text-amber-dim text-sm mt-0.5">
                {String(i + 1).padStart(2, '0')}
              </span>
              <span class="text-cream break-all">
                <a href={source}>{source}</a>
              </span>
            </li>
          ))}
        </ul>
      </footer>
    )}

  </article>
</Layout>
