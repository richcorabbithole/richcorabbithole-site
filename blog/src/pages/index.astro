---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import PostCard from '../components/PostCard.astro';
import DecoSection from '../components/DecoSection.astro';
import CategoryBadge from '../components/CategoryBadge.astro';
import DepthMeter from '../components/DepthMeter.astro';

const blogPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

// Sort by publish date, newest first
const sortedPosts = blogPosts.sort((a, b) =>
  b.data.publishDate.getTime() - a.data.publishDate.getTime()
);

const featuredPosts = sortedPosts.filter(p => p.data.featured);
const regularPosts = sortedPosts.filter(p => !p.data.featured);
---

<Layout title="richcorabbithole - A Cabinet of Curiosities">

  <!-- Hero Section -->
  <section class="max-w-5xl mx-auto px-6 py-16 text-center">
    <h2 class="font-heading text-5xl md:text-6xl font-bold text-ivory mb-4 tracking-wide">
      richcorabbithole
    </h2>
    <div class="rule-amber mx-auto mb-6 max-w-xs"></div>
    <p class="text-dust text-lg font-body tracking-wide max-w-xl mx-auto">
      A Cabinet of Curiosities &mdash;
      <span class="text-amber">deep dives</span> into tech, science,
      history, gaming &amp; maker projects
    </p>
  </section>

  <!-- Featured Curio -->
  {featuredPosts.length > 0 && (
    <section class="max-w-5xl mx-auto px-6 mb-16">
      <DecoSection title="Featured" />

      {featuredPosts.slice(0, 1).map((post) => (
        <a href={`${import.meta.env.BASE_URL}/blog/${post.slug}`}
           class="block group">
          <article class="border border-vault-raised bg-vault-mid p-8
                          hover:border-amber-dim hover:glow-amber
                          transition-all duration-300 relative">
            <div class="bracket-corners"></div>

            <div class="flex flex-wrap items-center gap-4 mb-4">
              <CategoryBadge category={post.data.hyperfixation} />
              <DepthMeter depth={post.data.researchDepth} />
            </div>

            <h3 class="font-heading text-3xl font-bold text-ivory mb-3
                        group-hover:text-amber transition-colors duration-200">
              {post.data.title}
            </h3>

            <p class="text-cream text-lg mb-4 leading-relaxed">
              {post.data.description}
            </p>

            <div class="flex flex-wrap items-center justify-between gap-4">
              <div class="flex gap-2 flex-wrap">
                {post.data.tags.map((tag: string) => (
                  <span class="text-xs text-faded font-mono px-2 py-0.5 bg-vault-panel">
                    {tag}
                  </span>
                ))}
              </div>
              <time class="text-sm text-faded font-mono">
                {post.data.publishDate.toLocaleDateString('en-US', {
                  year: 'numeric', month: 'long', day: 'numeric'
                })}
              </time>
            </div>
          </article>
        </a>
      ))}
    </section>
  )}

  <!-- The Collection -->
  <section class="max-w-5xl mx-auto px-6 pb-16">
    <DecoSection title="The Collection" />

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {regularPosts.map((post) => (
        <PostCard post={post} />
      ))}
    </div>
  </section>

</Layout>
