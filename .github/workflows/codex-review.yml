name: Codex Code Review

on:
  pull_request:
    branches: [development]
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: codex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  codex-review:
    runs-on: ubuntu-latest
    steps:
      - name: Verify OPENAI_API_KEY is available (safe)
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "OPENAI_API_KEY secret is NOT available to this workflow."
            exit 1
          fi
          echo "OPENAI_API_KEY secret is available."

      - name: Checkout PR merge commit
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
          fetch-depth: 0

      - name: Fetch base and head refs
        run: |
          git fetch --no-tags origin \
            ${{ github.event.pull_request.base.ref }} \
            +refs/pull/${{ github.event.pull_request.number }}/head

      - name: Generate diff for review
        run: |
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > /tmp/pr-diff.txt
          echo "Diff size: $(wc -l < /tmp/pr-diff.txt) lines"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Run Codex review
        env:
          CODEX_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          codex exec \
            --full-auto \
            --skip-git-repo-check \
            -o /tmp/review-output.md \
            "You are reviewing a pull request for an Astro + Vue + Tailwind CSS blog site.
          The tech stack is: Astro 5, Vue 3, TypeScript, Tailwind CSS 4.

          The PR diff is in /tmp/pr-diff.txt. Read that file and review the changes for:

          1. **Bugs & Logic Errors** â€” Incorrect logic, off-by-one errors, null/undefined risks, broken functionality.
          2. **Security** â€” XSS risks in templates, unsafe data handling, exposed secrets, dependency vulnerabilities.
          3. **Performance** â€” Unnecessary re-renders, unoptimized images, missing lazy loading, large bundle impacts.
          4. **TypeScript** â€” Missing types, unsafe any usage, incorrect type assertions.
          5. **Astro & Vue Best Practices** â€” Component patterns, frontmatter vs client-side code, content collection usage.
          6. **Code Quality** â€” Dead code, unclear naming, missing error handling, overly complex logic.

          Format your review as a structured markdown report with sections for each category.
          Only include sections where you found issues. If everything looks good in a category, omit it.
          Start with a brief summary of the PR changes and an overall assessment.
          Be constructive and specific â€” reference file names and line numbers where possible."

      - name: Post review comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const outputPath = '/tmp/review-output.md';

            if (!fs.existsSync(outputPath)) {
              console.log('No review output file found, skipping comment.');
              return;
            }

            const message = fs.readFileSync(outputPath, 'utf8').trim();

            if (!message) {
              console.log('Review output is empty, skipping comment.');
              return;
            }

            const header = '## ðŸ¤– Codex Code Review\n\n';
            const footer = '\n\n---\n*Automated review by [OpenAI Codex CLI](https://github.com/openai/codex) Â· triggered on PR to `development`*';
            const body = header + message + footer;

            // Check for an existing Codex review comment to update instead of duplicating
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.body.includes('ðŸ¤– Codex Code Review') &&
              c.user.type === 'Bot'
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
              console.log(`Updated existing review comment #${existing.id}`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
              console.log('Posted new review comment');
            }
